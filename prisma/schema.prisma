// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// ENUMS
// ============================================

enum PermitType {
  ISAG
  CSAG
}

enum ApplicationStatus {
  DRAFT
  PENDING_COORDINATE_APPROVAL    // DEPRECATED - keeping for backward compatibility
  COORDINATE_AUTO_APPROVED       // Coordinates auto-approved (no overlap detected)
  OVERLAP_DETECTED_PENDING_CONSENT  // Overlap detected, consent letter required
  COORDINATE_REVISION_REQUIRED   // Coordinates rejected, applicant must revise
  SUBMITTED
  ACCEPTANCE_IN_PROGRESS
  PENDING_OTHER_DOCUMENTS        // All acceptance reqs accepted, waiting for other docs upload
  PENDING_OTHER_DOCS_REVIEW      // Other documents submitted, waiting for admin review
  UNDER_REVIEW
  INITIAL_CHECK
  TECHNICAL_REVIEW
  FOR_FINAL_APPROVAL
  FOR_ACTION
  APPROVED
  REJECTED
  RETURNED
  VOIDED
  PAYMENT_PENDING
  PERMIT_ISSUED
}

enum Decision {
  APPROVED
  REJECTED
  RETURNED
}

enum PaymentStatus {
  PENDING
  PAID
  VERIFIED
}

enum DocumentType {
  // Mandatory Requirements
  APPLICATION_FORM
  SURVEY_PLAN
  LOCATION_MAP
  WORK_PROGRAM
  IEE_REPORT
  EPEP
  PROOF_TECHNICAL_COMPETENCE
  PROOF_FINANCIAL_CAPABILITY
  ARTICLES_INCORPORATION
  OTHER_SUPPORTING_PAPERS
  
  // Other Requirements
  AREA_STATUS_CLEARANCE_CENRO
  AREA_STATUS_CLEARANCE_MGB
  CERTIFICATE_POSTING_BARANGAY
  CERTIFICATE_POSTING_MUNICIPAL
  CERTIFICATE_POSTING_PROVINCIAL
  CERTIFICATE_POSTING_CENRO
  CERTIFICATE_POSTING_PENRO
  CERTIFICATE_POSTING_MGB
  ECC
  SANGGUNIAN_ENDORSEMENT_BARANGAY
  SANGGUNIAN_ENDORSEMENT_MUNICIPAL
  SANGGUNIAN_ENDORSEMENT_PROVINCIAL
  FIELD_VERIFICATION_REPORT
  SURETY_BOND
  
  // Additional/Returned Documents
  ADDITIONAL_DOCUMENT
  REVISED_DOCUMENT
}

enum CommentType {
  REMARK
  CLARIFICATION
  REVISION_REQUEST
  APPROVAL_NOTE
  REJECTION_REASON
}

enum AdminRole {
  ADMIN
  EVALUATOR
  REVIEWER
  PMRB
  REGIONAL_DIRECTOR
}

enum EvaluationType {
  INITIAL_CHECK
  TECHNICAL_REVIEW
  FINAL_APPROVAL
}

enum ChecklistCategory {
  DOCUMENT_VERIFICATION
  OTHER_REQUIREMENTS
  TECHNICAL_REVIEW
}

enum NotificationType {
  APPLICATION_SUBMITTED
  APPLICATION_RETURNED
  APPLICATION_APPROVED
  APPLICATION_REJECTED
  PAYMENT_REQUIRED
  PERMIT_READY
  STATUS_CHANGED
  COMMENT_ADDED
  DOCUMENT_REQUIRED
  REQUIREMENT_ACCEPTED
  REQUIREMENT_REJECTED
  REQUIREMENT_REVISION_NEEDED
  REQUIREMENT_PENDING_REVIEW
  APPLICATION_VOIDED
  REQUIREMENT_AUTO_ACCEPTED
  COORDINATES_SUBMITTED          // Coordinates submitted for review (to admin)
  COORDINATES_APPROVED           // Coordinates approved, can continue application
  COORDINATES_REJECTED           // Coordinates rejected, revision required
  COORDINATES_AUTO_APPROVED      // Admin didn't review within 14 working days
  COORDINATES_REVISION_EXPIRED   // Applicant didn't revise within 14 working days
  CONSENT_UPLOADED               // Phase 2.4: Consent document uploaded for admin verification
  CONSENT_VERIFIED               // Phase 2.4: Consent document verified by admin
  CONSENT_REJECTED               // Phase 2.4: Consent document rejected by admin
}

enum AcceptanceRequirementStatus {
  PENDING_SUBMISSION
  PENDING_REVIEW
  ACCEPTED
  REJECTED
  REVISION_REQUIRED
}

enum AcceptanceRequirementType {
  PROJECT_COORDINATES
  APPLICATION_FORM
  SURVEY_PLAN
  LOCATION_MAP
  WORK_PROGRAM
  IEE_REPORT
  EPEP
  PROOF_TECHNICAL_COMPETENCE
  PROOF_FINANCIAL_CAPABILITY
  ARTICLES_INCORPORATION
  OTHER_SUPPORTING_PAPERS
}

enum OtherDocumentStatus {
  PENDING_SUBMISSION
  PENDING_REVIEW
  ACCEPTED
  REVISION_REQUIRED
}

enum CoordinateHistoryStatus {
  ACTIVE      // Currently active coordinates
  REPLACED    // Superseded by new coordinates
  VOIDED      // Application voided
}

enum ConsentStatus {
  REQUIRED       // Consent document required
  UPLOADED       // Uploaded, pending verification
  VERIFIED       // Admin verified consent
  REJECTED       // Consent rejected by admin
  NOT_REQUIRED   // No consent needed (no overlap)
}

// ============================================
// MODELS
// ============================================

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String
  fullName      String
  birthdate     DateTime
  mobileNumber  String?

  // Account Type
  accountType   String   @default("INDIVIDUAL") // INDIVIDUAL or CORPORATE

  // Business Information
  companyName   String?

  // Representative Information (required for CORPORATE accounts)
  representativeFullName      String?
  representativeEmail         String?
  representativeContactNumber String?
  representativeBirthday      DateTime?

  // President Information (required for CORPORATE accounts)
  presidentFullName                String?
  presidentAuthorizationLetterUrl  String?

  // Address Components (Philippine Divisions)
  region        String?
  province      String?
  city          String?
  barangay      String?

  // Legacy address field (for backward compatibility - will be deprecated)
  address       String?

  // Required Corporate Documents
  governmentIdUrl      String?
  companyIdUrl         String?
  secDtiCertificateUrl String?

  // Account Status
  emailVerified Boolean  @default(false)
  emailVerificationToken String? @unique
  passwordResetToken     String? @unique
  passwordResetExpires   DateTime?

  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastLoginAt   DateTime?

  // Relations
  applications  Application[]
  notifications Notification[]

  @@map("users")
}

model Application {
  id            String   @id @default(cuid())
  applicationNo String  @unique @default("")
  
  // Permit Type
  permitType   PermitType
  
  // Applicant Information
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Project Information
  projectName  String?
  projectArea  Decimal? @db.Decimal(15, 2)
  footprintArea Decimal? @db.Decimal(15, 2)
  numEmployees Int?
  projectCost  Decimal? @db.Decimal(15, 2)
  projectCoordinates Json?  // 4-point coordinates {point1: {lat, lng}, point2: {lat, lng}, point3: {lat, lng}, point4: {lat, lng}}
  uploadedDocuments Json?   // Batch uploaded acceptance requirements {requirementType: {fileUrl, fileName}}

  // Coordinate Review (Phase 1 approval)
  coordinateReviewDeadline   DateTime?  // Admin must review within 14 working days
  coordinateRevisionDeadline DateTime?  // Applicant must revise within 14 working days
  coordinateApprovedAt       DateTime?  // When admin approved coordinates
  coordinateReviewRemarks    String?    @db.Text  // Admin remarks for approval/rejection
  coordinateAutoApproved     Boolean    @default(false)  // True if auto-approved (no overlap)
  
  // Overlap Detection & Consent
  overlappingProjectIds      Json?      // Array of project IDs that overlap with this application
  consentLetterUrl           String?    // Uploaded consent letter from existing permit holder
  consentLetterUploadedAt    DateTime?  // When consent letter was uploaded
  consentLetterFilename      String?    // Original filename of consent letter

  // Application Status
  status       ApplicationStatus @default(DRAFT)
  
  // Current Step (for draft applications)
  currentStep  Int      @default(1)
  
  // Submission
  submittedAt  DateTime?
  submittedTo  String?
  
  // Evaluation
  assignedTo  String?
  assignedAdmin AdminUser? @relation("AssignedApplications", fields: [assignedTo], references: [id])
  evaluatedBy String?
  reviewedBy  String?
  approvedBy  String?
  
  // Decision
  decision     Decision?
  decisionDate DateTime?
  decisionReason String? @db.Text
  
  // Payment
  paymentStatus PaymentStatus @default(PENDING)
  orderOfPaymentUrl String?
  paymentReceiptUrl String?
  paymentDate  DateTime?
  
  // Permit
  permitNumber String?
  permitUrl    String?
  permitIssuedAt DateTime?
  
  // Acceptance Requirements Tracking
  acceptanceRequirementsStartedAt DateTime?

  // Timestamps
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  documents    Document[]
  statusHistory ApplicationStatusHistory[]
  comments     Comment[]
  evaluations  Evaluation[]
  acceptanceRequirements AcceptanceRequirement[]
  otherDocuments OtherDocument[]
  notifications Notification[]
  coordinateHistory      CoordinateHistory[]
  newApplicationConsents OverlapConsent[] @relation("NewApplicationConsent")
  affectedConsents       OverlapConsent[] @relation("AffectedApplicationConsent")

  @@index([userId])
  @@index([status])
  @@index([permitType])
  @@index([applicationNo])
  @@index([assignedTo])
  @@map("applications")
}

model AcceptanceRequirement {
  id            String   @id @default(cuid())
  applicationId String
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  // Requirement Details
  requirementType AcceptanceRequirementType
  requirementName String
  requirementDescription String? @db.Text
  order          Int                                  // Sequence number for this requirement

  // Requirement Data/File
  submittedData  String?  @db.Text                    // For text data like coordinates
  submittedFileUrl String?                            // For uploaded files
  submittedFileName String?

  // Status
  status         AcceptanceRequirementStatus @default(PENDING_SUBMISSION)

  // Submission
  submittedAt    DateTime?
  submittedBy    String   @default("applicant")

  // Admin Review
  reviewedAt     DateTime?
  reviewedBy     String?
  adminRemarks   String?  @db.Text
  adminRemarkFileUrl String?                          // Optional file attached to remarks
  adminRemarkFileName String?
  
  // Compliance Tracking (REVISION 4 & 7)
  isCompliant    Boolean?                             // True = compliant, False = non-compliant, null = not yet reviewed
  complianceMarkedAt DateTime?                        // When compliance status was set
  complianceMarkedBy String?                          // Admin who marked compliance

  // Deadlines
  revisionDeadline DateTime?                          // 14 days from rejection
  autoAcceptDeadline DateTime?                        // Admin evaluation deadline

  // Flags
  isAutoAccepted Boolean  @default(false)
  isVoided       Boolean  @default(false)
  voidedAt       DateTime?
  voidReason     String?

  // Timestamps
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([applicationId])
  @@index([status])
  @@index([order])
  @@map("acceptance_requirements")
}

model OtherDocument {
  id                String   @id @default(cuid())
  applicationId     String
  application       Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  // Document Details
  documentType      String
  documentName      String
  status            OtherDocumentStatus @default(PENDING_SUBMISSION)

  // Submission
  submittedAt       DateTime?
  submittedBy       String?
  submittedFileUrl  String?
  submittedFileName String?

  // Admin Review
  reviewedAt        DateTime?
  reviewedBy        String?
  adminRemarks      String?  @db.Text
  adminRemarkFileUrl String?
  adminRemarkFileName String?
  
  // Compliance Tracking (REVISION 8)
  isCompliant    Boolean?                             // True = compliant, False = non-compliant, null = not yet reviewed
  complianceMarkedAt DateTime?                        // When compliance status was set
  complianceMarkedBy String?                          // Admin who marked compliance

  // Deadlines
  autoAcceptDeadline DateTime?
  revisionDeadline   DateTime?

  // Flags
  isAutoAccepted     Boolean @default(false)
  isVoided           Boolean @default(false)
  voidedAt           DateTime?
  voidReason         String?

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([applicationId])
  @@index([status])
  @@map("other_documents")
}

model Document {
  id            String   @id @default(cuid())
  applicationId String
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  
  // Document Information
  documentType  DocumentType
  documentName  String
  fileName      String
  fileUrl       String
  fileSize      Int
  mimeType      String
  
  // Document Set (for requirements that need 5 sets)
  setNumber     Int?
  
  // Status
  isRequired    Boolean  @default(true)
  isComplete    Boolean  @default(false)
  remarks       String?  @db.Text
  
  // Version Control
  version       Int      @default(1)
  replacedAt    DateTime?
  
  // Timestamps
  uploadedAt    DateTime @default(now())
  uploadedBy    String
  
  @@index([applicationId])
  @@index([documentType])
  @@map("documents")
}

model ApplicationStatusHistory {
  id            String   @id @default(cuid())
  applicationId String
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  
  // Status Change
  fromStatus    ApplicationStatus?
  toStatus      ApplicationStatus
  changedBy     String
  changedByRole String
  
  // Remarks
  remarks       String?  @db.Text
  
  // Attachments (evaluation reports, etc.)
  attachmentUrl String?
  
  // Timestamps
  createdAt     DateTime @default(now())
  
  @@index([applicationId])
  @@index([toStatus])
  @@map("application_status_history")
}

model Comment {
  id            String   @id @default(cuid())
  applicationId String
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  
  // Comment Details
  content       String   @db.Text
  commentType   CommentType @default(REMARK)
  
  // File Attachments (REVISION 10 - Multiple files support)
  attachments   Json?    // Array of {fileName: string, fileUrl: string}
  
  // Author
  authorId      String
  authorRole    String
  authorName    String
  
  // Reply/Thread
  parentId      String?
  parent        Comment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies       Comment[] @relation("CommentReplies")
  
  // Visibility
  isInternal    Boolean  @default(false)
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([applicationId])
  @@index([parentId])
  @@map("comments")
}

model AdminUser {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String
  
  // Personal Information
  fullName      String
  position      String?
  department    String?
  
  // Role & Permissions
  role          AdminRole @default(EVALUATOR)
  permissions   Json?
  
  // Account Status
  isActive      Boolean  @default(true)
  emailVerified Boolean @default(false)
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastLoginAt   DateTime?
  
  // Relations
  evaluations   Evaluation[]
  assignedApplications Application[] @relation("AssignedApplications")
  
  @@map("admin_users")
}

model Evaluation {
  id            String   @id @default(cuid())
  applicationId String
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  
  // Evaluator
  evaluatorId   String
  evaluator     AdminUser @relation(fields: [evaluatorId], references: [id])
  
  // Evaluation Type
  evaluationType EvaluationType
  
  // Checklist
  checklistItems EvaluationChecklistItem[]
  
  // Summary
  isCompliant   Boolean?
  summary       String?  @db.Text
  
  // Signatures
  evaluatedBy   String?
  evaluatedSignature String?
  evaluatedDate DateTime?
  
  reviewedBy    String?
  reviewedSignature String?
  reviewedDate  DateTime?
  
  approvedBy    String?
  approvedSignature String?
  approvedDate  DateTime?
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([applicationId, evaluationType])
  @@index([applicationId])
  @@index([evaluatorId])
  @@map("evaluations")
}

model EvaluationChecklistItem {
  id            String   @id @default(cuid())
  evaluationId  String
  evaluation    Evaluation @relation(fields: [evaluationId], references: [id], onDelete: Cascade)
  
  // Checklist Item
  itemNumber    Int
  itemName      String
  category      ChecklistCategory
  
  // Status
  isComplete    Boolean  @default(false)
  isCompliant   Boolean?
  remarks       String?  @db.Text
  
  // Timestamps
  checkedAt     DateTime?
  checkedBy     String?
  
  @@index([evaluationId])
  @@map("evaluation_checklist_items")
}

model Notification {
  id            String   @id @default(cuid())
  
  // Recipient
  userId        String?
  user          User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  adminUserId   String?
  
  // Related Application
  applicationId String?
  application   Application? @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  
  // Notification Details
  type          NotificationType
  title         String
  message      String   @db.Text
  link          String?
  
  // Status
  isRead        Boolean  @default(false)
  readAt        DateTime?
  
  // Email
  emailSent     Boolean  @default(false)
  emailSentAt   DateTime?
  
  // Timestamps
  createdAt     DateTime @default(now())
  
  @@index([userId])
  @@index([adminUserId])
  @@index([applicationId])
  @@index([isRead])
  @@map("notifications")
}

model ApplicationCounter {
  id        String   @id @default(cuid())
  year      Int
  month     Int
  counter   Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([year, month])
  @@map("application_counters")
}

model SystemSettings {
  id            String   @id @default(cuid())
  key           String   @unique
  value         String   @db.Text
  description   String?
  updatedAt     DateTime @updatedAt
  updatedBy     String?

  @@map("system_settings")
}

model CoordinateHistory {
  id                 String   @id @default(cuid())
  applicationId      String
  application        Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  // Coordinate Data
  coordinates        Json     // Array of {lat, lng} points (min 3, unlimited)
  pointCount         Int
  polygonGeoJSON     Json?    // GeoJSON representation for spatial queries

  // Status
  status             CoordinateHistoryStatus @default(ACTIVE)
  replacedAt         DateTime?
  replacedBy         String?  // Reference to new coordinate history ID

  // Metadata
  approvedAt         DateTime
  approvedBy         String

  // Spatial Index (for fast overlap queries)
  bounds             Json     // {minLat, maxLat, minLng, maxLng}

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  overlapConsents    OverlapConsent[] @relation("AffectedCoordinates")
  consentRequests    OverlapConsent[] @relation("NewCoordinates")

  @@index([applicationId])
  @@index([status])
  @@map("coordinate_history")
}

model OverlapConsent {
  id                    String   @id @default(cuid())

  // Application with new coordinates
  newApplicationId      String
  newApplication        Application @relation("NewApplicationConsent", fields: [newApplicationId], references: [id], onDelete: Cascade)
  newCoordinateHistoryId String
  newCoordinateHistory  CoordinateHistory @relation("NewCoordinates", fields: [newCoordinateHistoryId], references: [id])

  // Affected existing application
  affectedApplicationId String
  affectedApplication   Application @relation("AffectedApplicationConsent", fields: [affectedApplicationId], references: [id], onDelete: Cascade)
  affectedCoordinateHistoryId String
  affectedCoordinateHistory   CoordinateHistory @relation("AffectedCoordinates", fields: [affectedCoordinateHistoryId], references: [id])

  // Overlap Details
  overlapPercentage     Float    // Percentage of overlap
  overlapArea           Float?   // Calculated overlap area (optional)
  overlapGeoJSON        Json?    // GeoJSON of overlapping polygon

  // Consent Document
  consentStatus         ConsentStatus @default(REQUIRED)
  consentFileUrl        String?
  consentFileName       String?
  consentUploadedAt     DateTime?
  consentUploadedBy     String?  // User who uploaded

  // Admin Verification
  consentVerifiedAt     DateTime?
  consentVerifiedBy     String?  // Admin who verified
  verificationRemarks   String?  @db.Text

  // Notifications
  notificationSentAt    DateTime?
  affectedPartyNotified Boolean  @default(false)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([newApplicationId])
  @@index([affectedApplicationId])
  @@index([consentStatus])
  @@map("overlap_consents")
}
